<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <meta property="og:title" content="Deploy a fully automated web-app using AWS, Terraform and Ansible" />
<meta property="og:description" content="We would be using Infrastructure as Code (IaC) principle to fully automate the provisioning and deployment of all the components to successfully run a python application. The whole process can be divided into two tasks, Task 1: Provision the AWS infrastructure, Terraform is one of the best tool available to provision infratructure on your preferred cloud, Task 2: Deploy the software components, Once the infrastructure is put it place, In order to deploy highly scalable applications we would need a configuration management tool like Ansible to help deploy various software components to these virtual machines." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anees009.github.io/post/aws-terraform-ansible-webapp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-05T22:02:26&#43;00:00" />
<meta property="article:modified_time" content="2021-06-05T22:02:26&#43;00:00" /><meta property="og:site_name" content="Cloud &amp; Containers" />


        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploy a fully automated web-app using AWS, Terraform and Ansible"/>
<meta name="twitter:description" content="We would be using Infrastructure as Code (IaC) principle to fully automate the provisioning and deployment of all the components to successfully run a python application. The whole process can be divided into two tasks, Task 1: Provision the AWS infrastructure, Terraform is one of the best tool available to provision infratructure on your preferred cloud, Task 2: Deploy the software components, Once the infrastructure is put it place, In order to deploy highly scalable applications we would need a configuration management tool like Ansible to help deploy various software components to these virtual machines."/>
<meta name="twitter:site" content="@sssssbutton"/>

        
        <title>
  Deploy a fully automated web-app using AWS, Terraform and Ansible | Anees Patel
</title>

        <link rel="icon" type="image/png" href='https://anees009.github.io/images/favicon-16x16.png' sizes="16x16">
        <link rel="icon" type="image/png" href='https://anees009.github.io/images/favicon-32x32.png' sizes="32x32">  

        <link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">      
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
        
        
        
        

        <link rel="stylesheet" href="https://anees009.github.io/css/bundle.min.7dfde84a0a1e2dc95d42cbc6a5ef75756152e1d5250b280547d4971dc0c5b320.css" integrity="sha256-ff3oSgoeLcldQsvGpe91dWFS4dUlCygFR9SXHcDFsyA="  />

        
    <link rel="me" type="text/html" href="https://twitter.com/sssssbutton"/> 
<link rel="me" type="text/html" href="https://www.linkedin.com/in/anees-patel-00964182/"/> 
<link rel="icon" type="image/png" href="https://anees009.github.io/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="https://anees009.github.io/images/favicon-32x32.png" sizes="32x32">

<link rel="alternate" type="application/rss+xml" href='https://anees009.github.io/index.xml' />

<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="author" content="Anees Patel" />
<meta name="copyright" content="All rights reserved." />


<meta name="description" content="We would be using Infrastructure as Code (IaC) principle to fully automate the provisioning and deployment of all the components to successfully run a python application. The whole process can be divided into two tasks, Task 1: Provision the AWS infrastructure, Terraform is one of the best tool available to provision infratructure on your preferred cloud, Task 2: Deploy the software components, Once the infrastructure is put it place, In order to deploy highly scalable applications we would need a configuration management tool like Ansible to help deploy various software components to these virtual machines.">


    
        
    </head>
    <body>
        <nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark py-1 top-nav">
            <div class="container">
                    <a class="navbar-brand pr-2" href="https://anees009.github.io/">ANEES PATEL</a>
                <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="navbar-collapse collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
    <a class="nav-link active" href="https://anees009.github.io/categories/development/">Development</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://anees009.github.io/categories/golang/">Golang</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="https://anees009.github.io/about/">About</a>
</li>
                    </ul>
                    <div class="social-icons d-none d-lg-block">
                        <a class="py-2 px-2" href="https://twitter.com/sssssbutton"><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2" href="https://www.linkedin.com/in/anees-patel-00964182/"><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2" href="https://github.com/anees009"><i class="fab fa-github"></i></a>
<a class="py-2 px-2" href='https://anees009.github.io/index.xml'><i class="fas fa-rss"></i></a>

                    </div>
                </div>
            </div>
        </nav>

        
<header class="feature-image d-print-none">
</header>

        
        <div class="main">
            
<div class="container mt-4 post">
    <h1>Deploy a fully automated web-app using AWS, Terraform and Ansible</h1>
    <div class="mb-3">
    <small>
        <strong>By Anees Patel</strong>
        | <i class="far fa-calendar-alt"></i>&nbsp;Jun 5, 2021&nbsp;
        | <i class="fa fa-tags" title="Tags" aria-hidden="true"></i> <a href='https://anees009.github.io/tags/terraform/'>terraform</a>, <a href='https://anees009.github.io/tags/ansible/'>ansible</a>, <a href='https://anees009.github.io/tags/aws/'>aws</a>
    </small>
</div>

    <div class="share-icons d-flex justify-content-center d-print-none">
        <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fanees009.github.io%2fpost%2faws-terraform-ansible-webapp%2f&text=Deploy%20a%20fully%20automated%20web-app%20using%20AWS%2c%20Terraform%20and%20Ansible&tw_p=tweetbutton" class="p-2" title="Share on Twitter" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Tweet</small></div>
</a>

<a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fanees009.github.io%2fpost%2faws-terraform-ansible-webapp%2f&t=Deploy%20a%20fully%20automated%20web-app%20using%20AWS%2c%20Terraform%20and%20Ansible" class="p-2" title="Share on Facebook" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fanees009.github.io%2fpost%2faws-terraform-ansible-webapp%2f&title=Deploy%20a%20fully%20automated%20web-app%20using%20AWS%2c%20Terraform%20and%20Ansible&source=mattbutton.com" class="p-2" title="Share on LinkedIn" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="javascript:window.print()" title="Print this article" class="p-2" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fa fa-print fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Print</small></div>
</a>
    </div>

    <div class="mt-4 mb-4 main-content">
        <p>We would be using Infrastructure as Code (IaC) principle to fully automate the provisioning and deployment of all the components to successfully run a python application.
The whole process can be divided into two tasks,
Task 1: Provision the AWS infrastructure, <a href="https://www.terraform.io/">Terraform</a> is one of the best tool available to provision infratructure on your preferred cloud,
Task 2: Deploy the software components,
Once the infrastructure is put it place, In order to deploy highly scalable applications we would need a configuration management tool like <a href="https://www.ansible.com/">Ansible</a> to help deploy various software components to these virtual machines.</p>
<h2 id="prerequisites">Prerequisites:</h2>
<ul>
<li><a href="https://www.terraform.io/">Terraform</a> - Install Terraform</li>
<li><a href="https://www.ansible.com/">Ansible</a> - Install Ansible</li>
<li>python3</li>
<li>AWS free tier account with credentials for IAM user having Admin Access</li>
</ul>
<h2 id="sample-architecture">Sample Architecture</h2>
<ol>
<li>
<p>Provision 3 separate ec2 instances on AWS</p>
<pre><code>2 x application instances
1 x web-server
</code></pre>
</li>
<li>
<p>Deploy the python application to the application instances with the app serving on port 8000.</p>
</li>
<li>
<p>Deploy NGINX on the web-server which will act as reverse proxy and loadbalancing requests.</p>
</li>
</ol>
<p>As part of this deployment the following AWS resources will be deployed, All the AWS resouces only consume the free-tire account.</p>
<ol>
<li>1 instance of ec2 that will be a nginx web-server and a reverse proxy</li>
<li>2 instances of ec2 for app-server</li>
<li>1 key-part for ssh connections</li>
<li>1 VPC to isolate the network environment from existing resources</li>
<li>2 security groups, 1 each for web-server and app-server</li>
</ol>
<h2 id="deployment">Deployment:</h2>
<p>The source code can be found at this <a href="https://github.com/anees009/aws-terraform-ansible-webapp">github-repo</a> for your reference.<br>
Terraform has four stages and four major comamnds that cover the end-to-end workflow:</p>
<ul>
<li>terraform init</li>
<li>terraform plan</li>
<li>terraform apply</li>
<li>terraform destroy</li>
</ul>
<h3 id="project-structure">Project Structure</h3>
<pre><code>$tree
.
├── ansible
│   ├── roles
│   │   ├── app_server
│   │   │   ├── files
│   │   │   │   └── server.py
│   │   │   └── tasks
│   │   │       └── main.yml
│   │   └── web_server
│   │       └── tasks
│   │           └── main.yml
│   └── site.yml
├── inventory.tmpl
├── main.tf
├── nginx.tmpl
├── outputs.tf
├── variables.tf
└── vpc.tf

</code></pre><p>The sample <a href="https://github.com/anees009/aws-terraform-ansible-webapp/blob/main/ansible/roles/app_server/files/server.py">python-app</a> is a simple HTTP server which will keep listining at port 8000, It will serve the requests and respond with the IP of the host.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">http.server</span>
<span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;Hi there, I&#39;m served from </span><span class="si">%s</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="c1"># convert string to byte  </span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

</code></pre></div><h3 id="terraform-files">Terraform files</h3>
<p>This module discusses all terraform configurations in details</p>
<h4 id="define-mechanism-to-accept-aws-credentials">Define mechanism to accept AWS Credentials</h4>
<p>We will need to declare AWS creds on the command line</p>
<pre><code># export aws_access_key = &quot;&lt;AWS ACCESS KEY&gt;&quot;`
# export aws_secret_key = &quot;&lt;AWS SECRET KEY&gt;&quot;
</code></pre><p>Terraform will then accept the above credentials as variables to be used to provision infrastructure on AWS</p>
<h4 id="variablestf">variables.tf</h4>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span><span class="p">.</span> <span class="k">variable</span> <span class="s2">&#34;aws_access_key&#34;</span> {
<span class="n">2.   type</span>    <span class="o">=</span> <span class="k">string</span>
<span class="m">3</span><span class="p">.</span> }
<span class="m">4</span><span class="p">.</span> 
<span class="m">5</span><span class="p">.</span> <span class="k">variable</span> <span class="s2">&#34;aws_secret_key&#34;</span> {
<span class="n">6.   type</span>    <span class="o">=</span> <span class="k">string</span>
<span class="m">7</span><span class="p">.</span> }
</code></pre></div><h4 id="define-aws-as-the-cloud-provider">Define AWS as the cloud provider</h4>
<p>As Terraform is a cloud-agnositic tool that can be used for provising infrastructure on all major clouds, it is needed to define the cloud provider as each provider offers a different set of resources that can be managed, terraform provides plug-ins to each of these cloud vendors, hence we need to define the provider as AWS and issue the command <code>terraform init</code> to download the plug-ins needed for AWS.</p>
<h5 id="maintf">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span><span class="p">.</span> <span class="k">provider</span> <span class="s2">&#34;aws&#34;</span> {
<span class="n">2.   access_key</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">aws_access_key</span>
<span class="n">3.   secret_key</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">aws_secret_key</span>
<span class="n">4.   region</span>     <span class="o">=</span> <span class="s2">&#34;us-east-2&#34;</span>
<span class="m">5</span><span class="p">.</span> }
</code></pre></div><h4 id="define-a-vpc">Define a VPC</h4>
<p>Inorder to isolate our environment we will create a seperate VPC and a subnet within it to launch all our instances, we would then need to create an internet gateway to allow our subnet to access the outside world.</p>
<h5 id="vpctf">vpc.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span> <span class="p">.</span><span class="c1"> # Create a VPC to launch our instances into
</span><span class="c1"></span><span class="m">2</span> <span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;aws_vpc&#34; &#34;terraform_vpc&#34;</span> {
<span class="n">3 .   cidr_block</span> <span class="o">=</span> <span class="s2">&#34;10.0.0.0/16&#34;</span>
<span class="m">4</span> <span class="p">.</span> }
<span class="m">5</span> <span class="p">.</span> 
<span class="m">6</span> <span class="p">.</span><span class="c1"> # Create an internet gateway to give our subnet access to the outside world
</span><span class="c1"></span><span class="m">7</span> <span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;aws_internet_gateway&#34; &#34;terraform_vpc&#34;</span> {
<span class="n">8 .   vpc_id</span> <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="m">9</span> <span class="p">.</span> }
<span class="m">10</span><span class="p">.</span> 
<span class="m">11</span><span class="p">.</span><span class="c1"> # Grant the VPC internet access on its main route table
</span><span class="c1"></span><span class="m">12</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;aws_route&#34; &#34;internet_access&#34;</span> {
<span class="n">13.   route_table_id</span>         <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">main_route_table_id</span>
<span class="n">14.   destination_cidr_block</span> <span class="o">=</span> <span class="s2">&#34;0.0.0.0/0&#34;</span>
<span class="n">15.   gateway_id</span>             <span class="o">=</span> <span class="k">aws_internet_gateway</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="m">16</span><span class="p">.</span> }
<span class="m">17</span><span class="p">.</span> 
<span class="m">18</span><span class="p">.</span><span class="c1"> # Create a subnet to launch our instances into
</span><span class="c1"></span><span class="m">19</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;aws_subnet&#34; &#34;terraform_vpc&#34;</span> {
<span class="n">20.   vpc_id</span>                  <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="n">21.   cidr_block</span>              <span class="o">=</span> <span class="s2">&#34;10.0.0.0/24&#34;</span>
<span class="n">22.   map_public_ip_on_launch</span> <span class="o">=</span> <span class="kt">true</span>
<span class="m">23</span><span class="p">.</span> }
</code></pre></div><h4 id="create-a-seperate-keypair">Create a seperate keypair</h4>
<p>We will be generating a new private and public key pair <code>testingkey</code> to be used to access the vm&rsquo;s, we will then use the same key to create AWS ec2 instances.</p>
<h5 id="maintf-1">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">112</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;tls_private_key&#34; &#34;testingkey&#34;</span> {
<span class="n">113.   algorithm</span>   <span class="o">=</span> <span class="s2">&#34;RSA&#34;</span>
<span class="n">114.   rsa_bits</span>  <span class="o">=</span> <span class="m">4096</span>
<span class="m">115</span><span class="p">.</span> }
<span class="m">116</span><span class="p">.</span> 
<span class="m">117</span><span class="p">.</span> 
<span class="m">118</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;aws_key_pair&#34; &#34;generated_key&#34;</span> {
<span class="n">119.   key_name</span>   <span class="o">=</span> <span class="s2">&#34;testingkey_aws&#34;</span>
<span class="n">120.   public_key</span> <span class="o">=</span> <span class="k">tls_private_key</span><span class="p">.</span><span class="k">testingkey</span><span class="p">.</span><span class="k">public_key_openssh</span>
<span class="m">121</span><span class="p">.</span> }
<span class="m">122</span><span class="p">.</span> 
<span class="m">123</span><span class="p">.</span> 
<span class="m">124</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;local_file&#34; &#34;terraform_key&#34;</span> { 
<span class="n">125.   filename</span> <span class="o">=</span> <span class="s2">&#34;${path.module}/terraform_app.pem&#34;</span>
<span class="n">126.   content</span> <span class="o">=</span> <span class="k">tls_private_key</span><span class="p">.</span><span class="k">testingkey</span><span class="p">.</span><span class="k">private_key_pem</span>
<span class="m">127</span><span class="p">.</span>   <span class="k">provisioner</span> <span class="s2">&#34;local-exec&#34;</span> {
<span class="n">128.     command</span> <span class="o">=</span> <span class="s2">&#34;chmod 400 ${path.module}/terraform_app.pem&#34;</span>
<span class="m">129</span><span class="p">.</span> }
<span class="m">130</span><span class="p">.</span> }
</code></pre></div><h4 id="define-security-groups">Define security groups</h4>
<p>We will be creating two security groups, <code>app-server-sg</code> for app-servers and <code>web-server-sg</code> for web-server, <code>app-server-sg</code> will have only port <code>8000</code> open for internal communication from the <code>web-server-sg</code>,
webserver security group <code>web-server-sg</code> will allow ingress at port 80, hence webserver will be accessible to the internet and will act as a reverse proxy.</p>
<h5 id="maintf-2">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">7</span><span class="p">.</span>  <span class="k">module</span> <span class="s2">&#34;security_group1&#34;</span> {
<span class="n">8.    source</span>  <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/security-group/aws&#34;</span>
<span class="n">9.    version</span> <span class="o">=</span> <span class="s2">&#34;~&gt; 3.0&#34;</span>
<span class="m">10</span><span class="p">.</span> 
<span class="n">11.   name</span>        <span class="o">=</span> <span class="s2">&#34;app-server-sg&#34;</span>
<span class="n">12.   description</span> <span class="o">=</span> <span class="s2">&#34;Temporary security group for appserver&#34;</span>
<span class="n">13.   vpc_id</span>      <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="m">14</span><span class="p">.</span> 
<span class="n">15.   ingress_cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="p">]</span>
<span class="n">16.   ingress_rules</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;http-80-tcp&#34;, &#34;ssh-tcp&#34;</span><span class="p">]</span>
<span class="n">17.   egress_rules</span>        <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;all-all&#34;</span><span class="p">]</span>
<span class="n">18.   ingress_with_cidr_blocks</span> <span class="o">=</span> <span class="p">[</span>
<span class="m">19</span><span class="p">.</span>     {
<span class="n">20.       from_port</span>   <span class="o">=</span> <span class="m">8000</span>
<span class="n">21.       to_port</span>     <span class="o">=</span> <span class="m">8000</span>
<span class="n">22.       protocol</span>    <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
<span class="n">23.       description</span> <span class="o">=</span> <span class="s2">&#34;Port opened for webserver reverse proxy&#34;</span>
<span class="n">24.       cidr_blocks</span> <span class="o">=</span> <span class="s2">&#34;${aws_instance.web-server.public_ip}/32&#34;</span>
<span class="m">25</span><span class="p">.</span>     }<span class="p">,</span>
<span class="m">26</span><span class="p">.</span>     <span class="p">]</span>
<span class="m">27</span><span class="p">.</span> }
<span class="m">28</span><span class="p">.</span> 
<span class="m">29</span><span class="p">.</span> <span class="k">module</span> <span class="s2">&#34;security_group2&#34;</span> {
<span class="n">30.   source</span>  <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/security-group/aws&#34;</span>
<span class="n">31.   version</span> <span class="o">=</span> <span class="s2">&#34;~&gt; 3.0&#34;</span>
<span class="m">32</span><span class="p">.</span> 
<span class="n">33.   name</span>        <span class="o">=</span> <span class="s2">&#34;web-server-sg&#34;</span>
<span class="n">34.   description</span> <span class="o">=</span> <span class="s2">&#34;Temporary security group for webserver&#34;</span>
<span class="n">35.   vpc_id</span>      <span class="o">=</span> <span class="k">aws_vpc</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="m">36</span><span class="p">.</span> 
<span class="n">37.   ingress_cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="p">]</span>
<span class="n">38.   ingress_rules</span>       <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;http-80-tcp&#34;, &#34;ssh-tcp&#34;</span><span class="p">]</span>
<span class="n">39.   egress_rules</span>        <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;all-all&#34;</span><span class="p">]</span>
<span class="m">40</span><span class="p">.</span> }
<span class="m">41</span><span class="p">.</span>
</code></pre></div><h4 id="define-ec2-instances">Define ec2 instances.</h4>
<p>We will be provision two ec2 instances grouped under <code>app-servers</code> attaching the security group <code>app-server-sg</code>, Similarly we will provision one ec2 instance <code>web-server</code> attaching the security group <code>web-server-sg</code> to act as our frontend reverse proxy and load-balancer. All the ec2 instances will be created using the generated keypair. This way we can ensure seeamless ssh throughout the deployment, This will be useful when control is handed to Ansible, we will come to it a little later</p>
<h5 id="maintf-3">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">42</span><span class="p">.</span> <span class="k">module</span> <span class="s2">&#34;ec2_cluster1&#34;</span> {
<span class="n">43.   source</span>                 <span class="o">=</span> <span class="s2">&#34;terraform-aws-modules/ec2-instance/aws&#34;</span>
<span class="n">44.   version</span>                <span class="o">=</span> <span class="s2">&#34;~&gt; 2.0&#34;</span>
<span class="m">45</span><span class="p">.</span> 
<span class="n">46.   name</span>                   <span class="o">=</span> <span class="s2">&#34;app-servers&#34;</span>
<span class="n">47.   instance_count</span>         <span class="o">=</span> <span class="m">2</span>
<span class="m">48</span><span class="p">.</span> 
<span class="n">49.   ami</span>                    <span class="o">=</span> <span class="s2">&#34;ami-01aab85a5e4a5a0fe&#34;</span>
<span class="n">50.   instance_type</span>          <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>
<span class="n">51.   key_name</span>               <span class="o">=</span> <span class="k">aws_key_pair</span><span class="p">.</span><span class="k">generated_key</span><span class="p">.</span><span class="k">key_name</span>
<span class="n">52.   monitoring</span>             <span class="o">=</span> <span class="kt">true</span>
<span class="n">53.   vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="k">module</span><span class="p">.</span><span class="k">security_group1</span><span class="p">.</span><span class="k">this_security_group_id</span><span class="p">]</span>
<span class="n">54.   subnet_id</span>              <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="m">55</span><span class="p">.</span> 
<span class="m">56</span><span class="p">.</span> }
<span class="m">57</span><span class="p">.</span> 
<span class="m">58</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;aws_instance&#34; &#34;web-server&#34;</span> {
<span class="n">59.   ami</span>           <span class="o">=</span> <span class="s2">&#34;ami-01aab85a5e4a5a0fe&#34;</span>
<span class="n">60.   instance_type</span> <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>
<span class="n">61.   key_name</span>               <span class="o">=</span> <span class="k">aws_key_pair</span><span class="p">.</span><span class="k">generated_key</span><span class="p">.</span><span class="k">key_name</span>
<span class="n">62.   vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="k">module</span><span class="p">.</span><span class="k">security_group2</span><span class="p">.</span><span class="k">this_security_group_id</span><span class="p">]</span>
<span class="n">63.   subnet_id</span> <span class="o">=</span> <span class="k">aws_subnet</span><span class="p">.</span><span class="k">terraform_vpc</span><span class="p">.</span><span class="k">id</span>
<span class="n">64.   tags</span> <span class="o">=</span> {
<span class="n">65.     Name</span> <span class="o">=</span> <span class="s2">&#34;web-server&#34;</span>
<span class="m">66</span><span class="p">.</span>   }
<span class="m">67</span><span class="p">.</span>   }
<span class="m">68</span><span class="p">.</span>
</code></pre></div><h4 id="terraform-null_resource">Terraform null_resource</h4>
<p>Terraform <a href="https://www.terraform.io/docs/language/resources/provisioners/null_resource.html"><code>null_resource</code></a> is used to run provisioners that aren&rsquo;t directly associated with a specific resource. Since Terraform builds a dependency graph, <code>null_resource</code> has an argument <code>triggers</code>  which can be used to control exactly when its provisioner will run, In our case we would want to install git and python3 once the ec2 instances are up, this is done using <code>remote-exec</code> provisioner but we can only run it once the instances are up and running, in-order to control this we use <code>triggers</code> argument which will wait for private_ip and once private_ip is accessible the trigger is executed, meaining we assume that the instance is up and it is same to run <code>&quot;sudo yum install git -y&quot;, &quot;sudo yum install python3 -y&quot;, &quot;echo Done!&quot;</code>
We will also use the private key for <code>connection</code> to the instances</p>
<h5 id="maintf-4">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">69</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;null_resource&#34; &#34;cluster&#34;</span> {
<span class="n">70.   count</span> <span class="o">=</span> <span class="m">2</span>
<span class="n">71.   triggers</span> <span class="o">=</span> {
<span class="n">72.     cluster_instance_ips</span> <span class="o">=</span> <span class="k">element</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">ec2_cluster1</span><span class="p">.</span><span class="k">private_ip</span><span class="p">,</span> <span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">)</span>
<span class="m">73</span><span class="p">.</span>   }
<span class="m">74</span><span class="p">.</span>   <span class="k">connection</span> {
<span class="n">75.     host</span> <span class="o">=</span> <span class="k">element</span><span class="p">(</span><span class="k">module</span><span class="p">.</span><span class="k">ec2_cluster1</span><span class="p">.</span><span class="k">public_ip</span><span class="p">,</span> <span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">)</span>
<span class="n">76.     user</span>        <span class="o">=</span> <span class="s2">&#34;ec2-user&#34;</span>
<span class="n">77.     type</span>        <span class="o">=</span> <span class="s2">&#34;ssh&#34;</span>
<span class="n">78.     private_key</span> <span class="o">=</span> <span class="k">tls_private_key</span><span class="p">.</span><span class="k">testingkey</span><span class="p">.</span><span class="k">private_key_pem</span>
<span class="n">79.     timeout</span>     <span class="o">=</span> <span class="s2">&#34;10m&#34;</span>
<span class="m">80</span><span class="p">.</span>   }
<span class="m">81</span><span class="p">.</span>   <span class="k">provisioner</span> <span class="s2">&#34;remote-exec&#34;</span> {
<span class="n">82.     inline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;sudo yum install git -y&#34;, &#34;sudo yum install python3 -y&#34;, &#34;echo Done!&#34;</span><span class="p">]</span>
<span class="m">83</span><span class="p">.</span>     }
<span class="m">84</span><span class="p">.</span> }
<span class="m">85</span><span class="p">.</span> 
<span class="m">86</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;null_resource&#34; &#34;web-server&#34;</span> {
<span class="n">87.   triggers</span> <span class="o">=</span> {
<span class="n">88.     instance_ip</span> <span class="o">=</span> <span class="k">aws_instance</span><span class="p">.</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">.</span><span class="k">public_ip</span>
<span class="m">89</span><span class="p">.</span>   }
<span class="m">90</span><span class="p">.</span>   <span class="k">connection</span> {
<span class="n">91.     host</span> <span class="o">=</span> <span class="k">aws_instance</span><span class="p">.</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">.</span><span class="k">public_ip</span>
<span class="n">92.     user</span>        <span class="o">=</span> <span class="s2">&#34;ec2-user&#34;</span>
<span class="n">93.     type</span>        <span class="o">=</span> <span class="s2">&#34;ssh&#34;</span>
<span class="n">94.     private_key</span> <span class="o">=</span> <span class="k">tls_private_key</span><span class="p">.</span><span class="k">testingkey</span><span class="p">.</span><span class="k">private_key_pem</span>
<span class="n">95.     timeout</span>     <span class="o">=</span> <span class="s2">&#34;10m&#34;</span>
<span class="m">96</span><span class="p">.</span>   }
<span class="m">97</span><span class="p">.</span>   <span class="k">provisioner</span> <span class="s2">&#34;remote-exec&#34;</span> {
<span class="n">98.     inline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;sudo yum install git -y&#34;, &#34;sudo yum install python3 -y&#34;, &#34;echo Done!&#34;</span><span class="p">]</span>
<span class="m">99</span><span class="p">.</span>     }
<span class="m">100</span><span class="p">.</span> }
<span class="m">101</span><span class="p">.</span> 
</code></pre></div><p>At this moment we have defined all out AWS infrastructure, we have now completed the task 1,
We would now look at deploying the various software required for the web-app, we will be using ansible for the same.</p>
<h3 id="ansible-for-app-deployment">Ansible for app deployment</h3>
<p>Ansible works against a multiple managed hosts which are provided as an inventory_file, this <code>inventory.ini</code> will contain all the respective ip&rsquo;s of the aws resources, the format will be similar to</p>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="p">[</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">]</span>
<span class="err">&lt;</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="err">-</span><span class="k">ip</span><span class="err">&gt;</span><span class="c1"> # &lt;web-server-id&gt;
</span><span class="c1"></span>
<span class="p">[</span><span class="k">app</span><span class="err">-</span><span class="k">server</span><span class="p">]</span>
<span class="err">&lt;</span><span class="k">app</span><span class="err">-</span><span class="k">server</span><span class="err">-</span><span class="k">ip</span><span class="err">-</span><span class="m">1</span><span class="err">&gt;</span><span class="c1"> # &lt;app-server-id-1&gt;
</span><span class="c1"></span><span class="err">&lt;</span><span class="k">app</span><span class="err">-</span><span class="k">server</span><span class="err">-</span><span class="k">ip</span><span class="err">-</span><span class="m">2</span><span class="err">&gt;</span><span class="c1"> # &lt;app-server-id-2&gt;
</span></code></pre></div><p>This inventory file needs to be created dynamically as we only get the IPs once the ec2 instances are provisioned and running. As this file is a prerequisite for running Ansible, we will now look into how inventory file is created dynamically.</p>
<h4 id="terraform-templatefile-function">Terraform <code>templatefile</code> Function</h4>
<p><a href="https://www.terraform.io/docs/language/functions/templatefile.html"><code>templatefile</code></a> reads the file (In our case <code>inventory.tmpl</code>) at the given path, considers it as a tempale and replaces few varaible within the template as per the user specified variables.</p>
<h5 id="inventorytmpl">inventory.tmpl</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span><span class="p">.</span> <span class="p">[</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">]</span>
<span class="m">2</span><span class="p">.</span> <span class="si">${</span><span class="err">web-server-ip</span><span class="si">}</span><span class="c1"> # ${web-server-id}
</span><span class="c1"></span><span class="m">3</span><span class="p">.</span> 
<span class="m">4</span><span class="p">.</span> <span class="p">[</span><span class="k">app</span><span class="err">-</span><span class="k">server</span><span class="p">]</span>
<span class="m">4</span><span class="p">.</span> <span class="err">%</span>{ <span class="k">for</span> <span class="k">index</span><span class="p">,</span> <span class="k">ip</span> <span class="k">in</span> <span class="k">app</span><span class="err">-</span><span class="k">server</span><span class="err">-</span><span class="k">ip</span> <span class="err">~</span>}
<span class="m">6</span><span class="p">.</span> <span class="si">${</span><span class="err">ip</span><span class="si">}</span><span class="c1"> # ${app-server-id[index]}
</span><span class="c1"></span><span class="m">7</span><span class="p">.</span> <span class="err">%</span>{ <span class="k">endfor</span> <span class="err">~</span>}
</code></pre></div><p>In the above template we will replace all the needed variables by dynamically supplying them once those variables are available, i.e once AWS creates all the resources.
In order to replace the variables we need to output these values from terraform, <a href="https://www.terraform.io/docs/language/values/outputs.html"><code>Output Values</code></a> are like return values in terraform that allow us to return required values from the terraform.</p>
<h5 id="outputstf">outputs.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span> <span class="p">.</span><span class="c1"> ### The Ansible inventory file
</span><span class="c1"></span><span class="m">2</span> <span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;local_file&#34; &#34;AnsibleInventory&#34;</span> {
<span class="n">3 .  content</span> <span class="o">=</span> <span class="k">templatefile</span><span class="p">(</span><span class="s2">&#34;inventory.tmpl&#34;</span><span class="p">,</span>
<span class="m">4</span> <span class="p">.</span>  {
<span class="n">5 .   web-server-ip</span> <span class="o">=</span> <span class="k">aws_instance</span><span class="p">.</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">.</span><span class="k">public_ip</span><span class="p">,</span>
<span class="n">6 .   web-server-id</span> <span class="o">=</span> <span class="k">aws_instance</span><span class="p">.</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">.</span><span class="k">id</span><span class="p">,</span>
<span class="n">7 .   app-server-ip</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">ec2_cluster1</span><span class="p">.</span><span class="k">public_ip</span><span class="p">,</span>
<span class="n">8 .   app-server-id</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">ec2_cluster1</span><span class="p">.</span><span class="k">id</span><span class="p">,</span>
<span class="m">9</span> <span class="p">.</span>  }
<span class="m">10</span><span class="p">.</span>  <span class="p">)</span>
<span class="n">11.  filename</span> <span class="o">=</span> <span class="s2">&#34;inventory&#34;</span>
<span class="m">12</span><span class="p">.</span> }
<span class="m">13</span><span class="p">.</span> 
</code></pre></div><p>The above snippet will read the contents of local file <code>inventory.tmpl</code> and replace the variables with public IPs and instaces id&rsquo;s, it will then save the file as <code>inventory</code>, Note this file <code>inventory</code> is not available in the github repo as this is created dynamically once the infrastructure is provisioned.</p>
<h4 id="ansible-playbook">Ansible Playbook</h4>
<p>Ansible playbook consists of two roles <code>app_server</code> and <code>web_server</code> these roles will be executed on appropriate nodes</p>
<h5 id="ansiblesiteyml">ansible/site.yml</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span><span class="p">.</span> <span class="err">-</span> <span class="k">hosts</span><span class="err">:</span> <span class="k">app</span><span class="err">-</span><span class="k">server</span>
<span class="m">2</span><span class="p">.</span>   <span class="k">roles</span><span class="err">:</span>
<span class="m">3</span><span class="p">.</span>   <span class="err">-</span> <span class="k">app_server</span>
<span class="m">4</span><span class="p">.</span>   
<span class="m">5</span><span class="p">.</span> <span class="err">-</span> <span class="k">hosts</span><span class="err">:</span> <span class="k">web</span><span class="err">-</span><span class="k">server</span>
<span class="m">6</span><span class="p">.</span>   <span class="k">roles</span><span class="err">:</span>
<span class="m">7</span><span class="p">.</span>   <span class="err">-</span> <span class="k">web_server</span>
</code></pre></div><p><code>app_server</code> role will Upload the python app <code>ansible/roles/app_server/files/server.py</code> to both the <code>app-servers</code> and then run it.</p>
<h5 id="ansiblerolesapp_servertasksmainyml">ansible/roles/app_server/tasks/main.yml</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span><span class="p">.</span> <span class="err">-</span> <span class="k">name</span><span class="err">:</span> <span class="k">Upload</span> <span class="k">the</span> <span class="k">python</span> <span class="k">app</span> <span class="k">server</span>
<span class="n">2.   copy: src</span><span class="o">=</span><span class="n">files/server.py dest</span><span class="o">=</span><span class="s2">&#34;~/&#34;</span><span class="n"> mode</span><span class="o">=</span><span class="m">0700</span>
<span class="m">3</span><span class="p">.</span> 
<span class="m">4</span><span class="p">.</span> <span class="err">-</span> <span class="k">name</span><span class="err">:</span> <span class="k">Run</span> <span class="k">the</span> <span class="k">app</span> <span class="k">server</span>
<span class="m">5</span><span class="p">.</span>   <span class="k">shell</span><span class="err">:</span> <span class="k">nohup</span> <span class="k">python3</span> <span class="k">server</span><span class="p">.</span><span class="k">py</span> <span class="err">&lt;/</span><span class="k">dev</span><span class="err">/</span><span class="k">null</span> <span class="err">&gt;/</span><span class="k">dev</span><span class="err">/</span><span class="k">null</span> <span class="m">2</span><span class="err">&gt;&amp;</span><span class="m">1</span> <span class="err">&amp;</span>
</code></pre></div><h5 id="nginx-reverse-proxy-configuration">NGINX Reverse proxy configuration.</h5>
<p>It may be noted that for the <code>web-sever</code> we will be using <code>nginx</code> as a reverse proxy and a load-balancer against our two app-servers, for this to work we would need to modify the nginx default config file to listen to <code>port 80 </code> and forward requests to <code>port 8000</code> of the app-servers, this needs to be dynamically changed to provide the IP&rsquo;s of our app-servers, this is again achieved using Terraform <code>templatefile</code> Function,
I have created a <code>nginx.tmpl</code> config file with appropriate port forwarding now we would need to change the variables <code>app-server-ip</code>, agian this is done using <a href="https://www.terraform.io/docs/language/values/outputs.html"><code>Output Values</code></a>.</p>
<h5 id="outputstf-1">outputs.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">15</span><span class="p">.</span><span class="c1"> ### The nginx reverse proxy config file
</span><span class="c1"></span><span class="m">16</span><span class="p">.</span> <span class="k">resource</span> <span class="s2">&#34;local_file&#34; &#34;nginx-conf&#34;</span> {
<span class="n">17.  content</span> <span class="o">=</span> <span class="k">templatefile</span><span class="p">(</span><span class="s2">&#34;nginx.tmpl&#34;</span><span class="p">,</span>
<span class="m">18</span><span class="p">.</span>  {
<span class="n">19.   app-server-ip</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">ec2_cluster1</span><span class="p">.</span><span class="k">public_ip</span><span class="p">,</span>
<span class="m">20</span><span class="p">.</span>  }
<span class="m">21</span><span class="p">.</span>  <span class="p">)</span>
<span class="n">22.  filename</span> <span class="o">=</span> <span class="s2">&#34;nginx.conf&#34;</span>
<span class="m">23</span><span class="p">.</span> }
</code></pre></div><p>The above logic will use the <code>nginx.tmpl</code> file and create a new nginx config file <code>nginx.conf</code> with the appropriate values.</p>
<p>Similarly <code>web_server</code> role will install NGINX, copy the NGINX config file <code>nginx.conf</code> and restart the web server</p>
<h5 id="ansiblerolesweb_servertasksmainyml">ansible/roles/web_server/tasks/main.yml</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">1</span> <span class="p">.</span> <span class="err">-</span> <span class="k">name</span><span class="err">:</span> <span class="k">Install</span> <span class="k">nginx</span> <span class="m">1</span><span class="p">.</span><span class="m">12</span>
<span class="m">2</span> <span class="p">.</span>   <span class="k">become</span><span class="err">:</span> <span class="k">yes</span>
<span class="m">3</span> <span class="p">.</span>   <span class="k">command</span><span class="err">:</span> <span class="k">amazon</span><span class="err">-</span><span class="k">linux</span><span class="err">-</span><span class="k">extras</span> <span class="k">install</span> <span class="k">nginx1</span><span class="p">.</span><span class="m">12</span> <span class="err">-</span><span class="k">y</span>
<span class="m">4</span> <span class="p">.</span> 
<span class="m">5</span> <span class="p">.</span> <span class="err">-</span> <span class="k">name</span><span class="err">:</span> <span class="k">Copy</span> <span class="k">NGINX</span> <span class="k">config</span> <span class="k">file</span>
<span class="m">6</span> <span class="p">.</span>   <span class="k">become</span><span class="err">:</span> <span class="k">yes</span>
<span class="n">7 .   copy: src</span><span class="o">=</span><span class="p">..</span><span class="n">/../../nginx.conf dest</span><span class="o">=</span><span class="s2">&#34;/etc/nginx/nginx.conf&#34;</span><span class="n"> mode</span><span class="o">=</span><span class="m">0700</span>
<span class="m">8</span> <span class="p">.</span> 
<span class="m">9</span> <span class="p">.</span> <span class="err">-</span> <span class="k">name</span><span class="err">:</span> <span class="k">Make</span> <span class="k">Sure</span> <span class="k">NGINX</span> <span class="k">Service</span> <span class="k">Is</span> <span class="k">Running</span>
<span class="m">10</span><span class="p">.</span>   <span class="k">become</span><span class="err">:</span> <span class="k">yes</span>
<span class="m">11</span><span class="p">.</span>   <span class="k">service</span><span class="err">:</span>
<span class="m">12</span><span class="p">.</span>     <span class="k">name</span><span class="err">:</span> <span class="k">nginx</span>
<span class="m">13</span><span class="p">.</span>     <span class="k">state</span><span class="err">:</span> <span class="k">restarted</span>
<span class="m">14</span><span class="p">.</span>     <span class="k">enabled</span><span class="err">:</span> <span class="k">yes</span>
</code></pre></div><h3 id="execution-of-ansible-playbook-from-within-terraform">Execution of Ansible playbook from within terraform</h3>
<p>As we have now looked into the details of our ansible playbook, we will now be looking at how this playbook is executed from within Terraform
The following snippet triggers the ansible-playbook against the <code>inventory</code> file, Note that we are supplying the private key for passwordless ssh</p>
<h5 id="maintf-5">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">102</span><span class="p">.</span> <span class="k">resource</span> <span class="k">null_resource</span> <span class="s2">&#34;ansible_deploy_app&#34;</span> {
<span class="n">103.   depends_on</span> <span class="o">=</span> <span class="p">[</span>
<span class="m">104</span><span class="p">.</span>     <span class="k">null_resource</span><span class="p">.</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">,</span> <span class="k">null_resource</span><span class="p">.</span><span class="k">cluster</span><span class="p">,</span> <span class="k">local_file</span><span class="p">.</span><span class="k">terraform_key</span>
<span class="m">105</span><span class="p">.</span>   <span class="p">]</span>
<span class="m">106</span><span class="p">.</span> 
<span class="m">107</span><span class="p">.</span>   <span class="k">provisioner</span> <span class="s2">&#34;local-exec&#34;</span> {
<span class="n">108.     command</span> <span class="o">=</span><span class="n"> &#34;sleep 45; ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span><span class="k">False</span> <span class="k">ansible</span><span class="err">-</span><span class="k">playbook</span> <span class="err">-</span><span class="k">u</span> <span class="k">ec2</span><span class="err">-</span><span class="k">user</span> <span class="err">--</span><span class="k">private</span><span class="err">-</span><span class="k">key</span> <span class="k">terraform_app</span><span class="p">.</span><span class="k">pem</span> <span class="err">-</span><span class="k">i</span> <span class="k">inventory</span> <span class="k">ansible</span><span class="err">/</span><span class="k">site</span><span class="p">.</span><span class="k">yml</span><span class="err">&#34;</span>
<span class="m">109</span><span class="p">.</span>   }
<span class="m">110</span><span class="p">.</span> }
<span class="m">111</span><span class="p">.</span> 
</code></pre></div><p>The provisioner used here is <code>local-exec</code> meaning ansible is executed on local host against a inventory of remote hosts, Also we use <code>depends_on</code> parameter, this is a wait mechanism, when the provisioner is only executed after <code>null_resource.web-server</code>, <code>null_resource.cluster</code>, <code>local_file.terraform_key</code> are created. This way Terraform constructs the dependency graph to avoid early execution of playbook.</p>
<h3 id="public-ip-of-web-server">Public Ip of web-server</h3>
<p>Once the deployment is completed, we would need the public IP of web-server to test our deployment, we can output the Public IP to the console again using Terraform <a href="https://www.terraform.io/docs/language/values/outputs.html"><code>Output Values</code></a> parameter.</p>
<h5 id="maintf-6">main.tf</h5>
<div class="highlight"><pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="m">131</span><span class="p">.</span> <span class="k">output</span> <span class="s2">&#34;Public_IP&#34;</span> {
<span class="n">132.   value</span> <span class="o">=</span> <span class="k">aws_instance</span><span class="p">.</span><span class="k">web</span><span class="err">-</span><span class="k">server</span><span class="p">.</span><span class="k">public_ip</span>
<span class="n">133.   description</span> <span class="o">=</span> <span class="s2">&#34;The Public IP address of the main web-server.&#34;</span>
<span class="m">134</span><span class="p">.</span> }
</code></pre></div><h3 id="trigger-the-following-commands-to-actually-deploy-the-app">Trigger the following commands to actually deploy the app</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ terraform init
$  terraform plan
$  terraform apply
</code></pre></div><p>We can now do a curl request to confirm our deployment, For my sample deployment I can see the request being served in a round-robin way.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> curl http://&lt;Public_IP_web-server&gt;/<span class="p">;</span> sleep 2<span class="p">;</span> <span class="k">done</span>
Hi there, I<span class="s1">&#39;m served from ip-10-0-0-225.us-east-2.compute.internal!
</span><span class="s1">Hi there, I&#39;</span>m served from ip-10-0-0-233.us-east-2.compute.internal!
Hi there, I<span class="s1">&#39;m served from ip-10-0-0-225.us-east-2.compute.internal!
</span><span class="s1">Hi there, I&#39;</span>m served from ip-10-0-0-233.us-east-2.compute.internal!
Hi there, I<span class="s1">&#39;m served from ip-10-0-0-225.us-east-2.compute.internal!
</span><span class="s1">Hi there, I&#39;</span>m served from ip-10-0-0-233.us-east-2.compute.internal!
Hi there, I<span class="err">&#39;</span>m served from ip-10-0-0-225.us-east-2.compute.internal!
</code></pre></div><h3 id="destroy-the-infrastructure-and-all-its-resources">Destroy the infrastructure and all its resources</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ terraform destroy
</code></pre></div><p>This will destroy all the AWS resources created for this application including the security groups and the VPC.</p>


        <div class="share-icons d-flex justify-content-center d-print-none">
            <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fanees009.github.io%2fpost%2faws-terraform-ansible-webapp%2f&text=Deploy%20a%20fully%20automated%20web-app%20using%20AWS%2c%20Terraform%20and%20Ansible&tw_p=tweetbutton" class="p-2" title="Share on Twitter" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Tweet</small></div>
</a>

<a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fanees009.github.io%2fpost%2faws-terraform-ansible-webapp%2f&t=Deploy%20a%20fully%20automated%20web-app%20using%20AWS%2c%20Terraform%20and%20Ansible" class="p-2" title="Share on Facebook" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fanees009.github.io%2fpost%2faws-terraform-ansible-webapp%2f&title=Deploy%20a%20fully%20automated%20web-app%20using%20AWS%2c%20Terraform%20and%20Ansible&source=mattbutton.com" class="p-2" title="Share on LinkedIn" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Share</small></div>
</a>

<a href="javascript:window.print()" title="Print this article" class="p-2" target="_blank" rel="nofollow">
    <div>
        <span class="fa-stack">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fa fa-print fa-stack-1x fa-inverse"></i>
        </span>
    </div>
    <div class="fa-inverse text-center"><small>Print</small></div>
</a>
        </div>
    </div>

    
</div>
<div class="sidebar d-print-none d-none d-xl-block">
    
        <h2>Anees Patel</h2>
        <div>
            All things Linux
        </div>
        <a href='https://anees009.github.io/about/' class="btn btn-outline-secondary mt-3" role="button">Read More...</a>
        <h2 class="mt-4">Top Posts</h2>
    
    
    <h2 class="mt-4">Recent Posts</h2>
    <nav class="nav flex-column">
        
        <a href="https://anees009.github.io/post/aws-terraform-ansible-webapp/" class="nav-link">Deploy a fully automated web-app using AWS, Terraform and Ansible</a>
        
    </nav>
    
    <h2 class="mt-4 text-capitalize">categories</h2>
    <nav class="nav flex-column">
        
        <a href='https://anees009.github.io/categories/software-development/' class="nav-link">
        software-development
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
    </nav>
    
    <h2 class="mt-4 text-capitalize">tags</h2>
    <nav class="nav flex-column">
        
        <a href='https://anees009.github.io/tags/ansible/' class="nav-link">
        ansible
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='https://anees009.github.io/tags/aws/' class="nav-link">
        aws
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
        <a href='https://anees009.github.io/tags/terraform/' class="nav-link">
        terraform
        <span class="badge badge-pill badge-secondary">1</span>
        </a>
        
    </nav>
    
</div>

        </div>

        <footer class="mt-auto footer d-print-none">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-md-4 col-xl-3">
                        <h5>All rights reserved.</h5>
I&#39;m happy for you to share content on this site, 
                    </div>
                    <div class="col-md-4 col-xl-3">
                        <h5>Disclaimer</h5>
Opinions expressed here are my own and may not reflect those of the company I work for, or the people I work with.
                    </div>
                    <div class="col-md-4 col-xl-3">
                        <h5>About This Site</h5>
This blog is maintained by <a href="https://www.linkedin.com/in/anees-patel-00964182/"> Anees Patel</a>
                    </div>
                </div>

                <hr />

                <div class="d-flex justify-content-center icons">
                    <a class="py-2 px-2" href="https://twitter.com/sssssbutton"><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2" href="https://www.linkedin.com/in/anees-patel-00964182/"><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2" href="https://github.com/anees009"><i class="fab fa-github"></i></a>
<a class="py-2 px-2" href='https://anees009.github.io/index.xml'><i class="fas fa-rss"></i></a>

                </div>
            </div>
        </footer>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        
    </body>
</html>
